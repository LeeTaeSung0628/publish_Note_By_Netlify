<!DOCTYPE html>
<html><head>
<title>🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안</title>
<base href="..">
<meta id="root-path" root-path="..">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
<meta charset="UTF-8">
<meta name="description" content="blog - 🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안">
<meta property="og:title" content="🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안">
<meta property="og:description" content="blog - 🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안">
<meta property="og:type" content="website">
<meta property="og:url" content="http://lts.kr/issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html">
<meta property="og:image" content="undefined">
<meta property="og:site_name" content="blog">
<meta name="author" content="taesung's Blog"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="http://lts.kr/lib/rss.xml"></head><body class="publish css-settings-manager theme-dark show-inline-title show-ribbon is-focused"><include src="lib/html/custom-head-content.html"></include><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6):has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(const t of e){let e=t.getAttribute("src");try{const o=await fetch(e);if(!o.ok){console.log("Could not include file: "+e),t?.remove();continue}let l=await o.text(),n=document.createRange().createContextualFragment(l),c=Array.from(n.children);for(let e of c)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);t.before(n),t.remove(),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><div class="search-input-wrapper"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안"><p dir="auto">🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안</p></h1><div class="el-h1 heading-wrapper"><div class="heading-children"><div class="el-p"><p dir="auto"><a href="?query=tag:SQL" class="tag is-unresolved" target="_self" rel="noopener nofollow" data-href="#SQL">#SQL</a> <a href="?query=tag:Lock" class="tag is-unresolved" target="_self" rel="noopener nofollow" data-href="#Lock">#Lock</a> <a href="?query=tag:%EA%B0%9C%EC%84%A0" class="tag is-unresolved" target="_self" rel="noopener nofollow" data-href="#개선">#개선</a> <a href="?query=tag:%EC%9D%B4%EC%8A%88" class="tag is-unresolved" target="_self" rel="noopener nofollow" data-href="#이슈">#이슈</a> <a href="?query=tag:%EC%84%B8%EB%AF%B8%EB%82%98" class="tag is-unresolved" target="_self" rel="noopener nofollow" data-href="#세미나">#세미나</a></p></div><div class="el-hr"><hr></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="DB관련 공부 정리 ◀" dir="auto" class="heading" id="DB관련_공부_정리_◀">DB관련 공부 정리 ◀</h1><div class="heading-children"><div class="el-h3 heading-wrapper"><h3 data-heading="[[📔 DataBase]]" dir="auto" class="heading" id="[[📔_DataBase]]"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-href="📔 DataBase" href="study/cs/📔-database.html" class="internal-link" target="_self" rel="noopener nofollow">📔 DataBase</a></h3><div class="heading-children"><div class="el-hr"><hr></div></div></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="투자 서비스에서 어떤 이슈가 있는가?" dir="auto" class="heading" id="투자_서비스에서_어떤_이슈가_있는가?">투자 서비스에서 어떤 이슈가 있는가?</h1><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<ol>
<li data-line="0" dir="auto">투자자 투자실행 시 <strong>순서보장X</strong></li>
</ol>
</li>
<li data-line="1" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<ol start="2">
<li data-line="1" dir="auto">Lock해제와 정합성 이슈</li>
</ol>
</li>
</ul></div><div class="el-hr"><hr></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="상품 투자 서비스 구성" dir="auto" class="heading" id="상품_투자_서비스_구성">상품 투자 서비스 구성</h1><div class="heading-children"><div class="el-p"><p dir="auto">헬로의 투자 서비스는 다음과 같다.</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">특정 scf / 주택담보대출 상품에 대해 투자자를 모집한다.</li>
<li data-line="1" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>투자자들은 특정시간에 open되는 상품에 일괄적으로 투자신청을한다.
<ol>
<li data-line="2" dir="auto">이때, 각 회원별로 "투자 신청 기록"을 진행한다.</li>
<li data-line="3" dir="auto"><em>투자신청 기록</em>이란, <em>P2PCenter</em>(금융결제원) API를 통해 유효성(투자기록 / 투자한도)을 조회하여 투자적합여부를 체크하고 기록하는것을 말한다.</li>
</ol>
</li>
<li data-line="4" dir="auto">회원별 검증 및 투자금 계산을 마치면 정상 투자가 진행된다.</li>
</ul></div><div class="el-p"><p dir="auto">이때, <em>투자신청 기록</em> 로직에서 Lock기법이 적용되어있다.</p></div><div class="el-hr"><hr></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="대기열 대신 Lock기법이 사용된 이유" dir="auto" class="heading" id="대기열_대신_Lock기법이_사용된_이유">대기열 대신 Lock기법이 사용된 이유</h1><div class="heading-children"><div class="el-h3 heading-wrapper"><h3 data-heading="lock" dir="auto" class="heading" id="lock"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>lock</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">
<p>Lock기법은 여러 요청이 같은 리소스에 접근하려 할 때, <strong>한 번에 하나의 요청만을 처리하도록 막는 기법이다.</strong></p>
</li>
<li data-line="1" dir="auto">
<p>데이터 정합성이 무엇보다 중요한 서비스에서 충돌을 방지하여 일관성을 효과적으로 유지하기 위함이다.</p>
</li>
<li data-line="3" dir="auto">
<p><code>헬로 서비스의 경우</code>, 회원 idx로 lock을 유지하여 성능과 안정성 확보<br>
-<em>상품별 한도</em> / <em>투자자 일별 투자상한</em> / <em>투자 금액</em> / <em>예치금</em> 등 정합성이 무엇보다 우선시 되는 데이터들이 포함</p>
</li>
</ul></div><div class="el-h4 heading-wrapper"><h4 data-heading="ex1) java `synchronized` 키워드 사용" dir="auto" class="heading" id="ex1)_java_`synchronized`_키워드_사용"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>ex1) java <code>synchronized</code> 키워드 사용</h4><div class="heading-children"><div class="el-p"><p dir="auto">(JVM 레벨 Lock)</p></div><div class="el-pre"><pre class="language-java" tabindex="0"><code data-line="0" class="language-java is-loaded"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedLockService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - 현재 카운트: "</span> <span class="token operator">+</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">JVM레벨에서 동작하므로, 분산환경에서는 동작 X, 성능 빠름</li>
</ul></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="ex2) Database Lock" dir="auto" class="heading" id="ex2)_Database_Lock"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>ex2) Database Lock</h4><div class="heading-children"><div class="el-p"><p dir="auto">(DB를 활용하여 Lock구현)</p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> lock_table <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    locked <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">FALSE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-java" tabindex="0"><code data-line="0" class="language-java is-loaded">
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomethingWithLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 행 잠금 (SELECT FOR UPDATE)</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM lock_table WHERE id = 1 FOR UPDATE"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rowNum<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - 데이터베이스 Lock 획득!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 작업 수행</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - 작업 완료!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">DB만으로 구현 가능, 트렌젝션 격리레벨에 따라 멀티인스턴스(분산환경)에서 정합성 보장 가능</li>
<li data-line="1" dir="auto">모든 요청이 DB lock을 기다리므로 속도 느림(lock이 해제될때 까지 대기), 데드락 가능성있음<br>
-&gt; <em>레디션 락은 블록킹하지 않고, Polling방식으로 재시도 가능.</em><br>
<em>커넥션 pool 미 소유 및 TTL로 데드락 방지</em></li>
</ul></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="대기열" dir="auto" class="heading" id="대기열"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>대기열</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">설계 방법에 따라, 강한 일관성 유지 가능하지만, 추가적인 설계/개발이 필요.</li>
<li data-line="1" dir="auto">높은 트래픽을 감당할 수 있음. (동시요청)</li>
<li data-line="2" dir="auto">수평적 확장에 용이(스케일 아웃)</li>
</ul></div><div class="el-h4 heading-wrapper"><h4 data-heading="결론" dir="auto" class="heading" id="결론"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>결론</h4><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">설계 방법에 따라, lock / 대기열 모두 일관성(데이터 정합성)을 유지할 수 있지만,<br>
lock 기법 사용시 추가적인 셋팅 없이 쉽게 일관성 및 실시간 처리를 구현할 수 있기에 채택되었다.</li>
</ul></div><div class="el-hr"><hr></div></div></div></div></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="scf의 상품 특성과 이해" dir="auto" class="heading" id="scf의_상품_특성과_이해">scf의 상품 특성과 이해</h1><div class="heading-children"><div class="el-h3 heading-wrapper"><h3 data-heading="락을 잡아놓고(lock안에서의 서비스로직) api통신을 하는이유?" dir="auto" class="heading" id="락을_잡아놓고(lock안에서의_서비스로직)_api통신을_하는이유?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>락을 잡아놓고(lock안에서의 서비스로직) api통신을 하는이유?</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">동시성 이슈를 해결하고자.</li>
</ul></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg></div><div class="callout-title-inner">동시성 이슈란?</div></div><div class="callout-content">
<ul>
<li data-line="1" dir="auto">문맥에 따라 조금씩 차이는 있겠지만<br>
여기서는 '여러 스레드가 동시에 공유 자원에 접근할 때 발생하는 문제'<br>
로 정의하겠다.</li>
</ul>
</div></div></div><div class="el-p"><p dir="auto"><em>동시성 이슈를 대응해야할 곳.</em></p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><code>모집금액</code>과, <code>상품 별 동일 차주 투자 한도</code>를 넘지 않게 상품의 동시성 이슈</li>
<li data-line="1" dir="auto">p2p투자한도와 예치금 한도를 넘지 않게 회원별 동시성 이슈</li>
</ol></div><div class="el-p"><p dir="auto">우리는 외부은행에 투자자,대출자 돈을 모두 맡겨두고 운영(신탁 운영)중이다.</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><em>한도를 금결원 api를 통해 매번 체크</em></li>
</ul></div><div class="el-p"><p dir="auto">실제 돈이 빠져나가는 시점은, 모든 투자기록을 마친 후, 대출을 실행하는 시점에서 돈을 가져간다.</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><em>회원별 동시성</em></li>
</ul></div><div class="el-p"><p dir="auto">세마포어 뮤텍스 비관적락 등 여러 방법론이 있지만, 우리는 <strong>redisson lock</strong>을 사용하였다.</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">k8s를 통해 여러 server를 띄워놓는 <em>분산환경</em>이기 때문.</li>
</ul></div><div class="el-hr"><hr></div></div></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="redisson lock 사용이유" dir="auto" class="heading" id="redisson_lock_사용이유">redisson lock 사용이유</h1><div class="heading-children"><div class="el-p"><p dir="auto">먼저, <code>헬로 투자하기</code> 서비스는 <font color="#d83931">redisson lock</font>을 사용한다.</p></div><div class="el-pre"><pre class="language-java" tabindex="0"><code data-line="0" class="language-java is-loaded"><span class="token class-name">Lock</span> testLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"affterProcessorLock-"</span> <span class="token operator">+</span> <span class="token class-name">Idx</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
testLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...투자 로직</span>
testLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4 heading-wrapper"><h4 data-heading="레디션 락(redisson lock)이란?" dir="auto" class="heading" id="레디션_락(redisson_lock)이란?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>레디션 락(redisson lock)이란?</h4><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">Redis기반의 분산 락 구현체이다.</li>
<li data-line="1" dir="auto">멀티 서버 환겨에서 동시성 문제를 해결하기 위해 사용된다.</li>
<li data-line="2" dir="auto">여러개의 애플리케이션 인스턴스가 <em>동일한 공유자원</em>에 접근할 때, 중복 처리나 데잍터 불일치 문제를 방지해준다.</li>
</ul></div><div class="el-p"><p dir="auto">단일 서버 환경에서는 <code>synchronized</code>, 일반 <code>Lock</code>을 통해 임계 구역을 보호할 수 있다.<br>
하지만, 멀티서버(분산 시스템) 환경에서는 이런</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>임계구역(Critical Section) : 여러 프로세스 또는 스레드가 <strong>공유 자원(Shared Resource)</strong> 에 접근하는 코드 영역</p>
</blockquote></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="결론" dir="auto" class="heading" id="결론"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>결론</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">분산 환경에서의 동시성 문제를 효과적으로 해결하기 위함</li>
</ul></div><div class="el-hr"><hr></div></div></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="이슈" dir="auto" class="heading" id="이슈">이슈</h1><div class="heading-children"><div class="el-h2 heading-wrapper"><h2 data-heading="1.투자자 별 투자완료까지의 순서를 보장하지 못한다." dir="auto" class="heading" id="1.투자자_별_투자완료까지의_순서를_보장하지_못한다."><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.투자자 별 투자완료까지의 순서를 보장하지 못한다.</h2><div class="heading-children"><div class="el-p"><p dir="auto"><em>싱글스레드 큐 방식의 Redis는 왜 순서를 보장하지 않는가?</em></p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Redis가 lock을 관리하는 과정 자체는 싱글 스레드 큐 방식이다.<br>
허나, Redisson Lock은 <strong>비동기 이벤트 기반의 락 처리 방식</strong>을 사용한다.</li>
<li data-line="2" dir="auto">즉, 락을 흭득하려는 프로세스는 우선순위가 없는 <strong>경쟁적락</strong>방식이다.</li>
</ul></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg></div><div class="callout-title-inner">정보</div></div><div class="callout-content">
<p dir="auto">FIFO 방식의 "공정 락(Fair Lock)"또한 지원하여 원하는 바 사용 가능하다.</p>
<ul>
<li data-line="2" dir="auto">대기열 방식이라고 봐도 되겠다.</li>
</ul>
</div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="기본 Redisson Lock의 동작 방식" dir="auto" class="heading" id="기본_Redisson_Lock의_동작_방식"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>기본 Redisson Lock의 동작 방식</h3><div class="heading-children"><div class="el-ol"><ol>
<li data-line="0" dir="auto">여러 클라이언트(서버 또는 스레드)가 <strong>동시에 같은 락을 요청</strong>할 수 있음.</li>
<li data-line="1" dir="auto"><strong>가장 먼저 Redis에 락을 설정한 클라이언트가 락을 획득</strong>(경쟁 방식).</li>
<li data-line="2" dir="auto">락을 획득한 클라이언트가 해제해야 다른 클라이언트가 락을 획득 가능.</li>
<li data-line="3" dir="auto">락이 만료되거나 자동 연장(Watchdog)되면서 동작.</li>
</ol></div><div class="el-p"><p dir="auto">이러한 동작 방식 때문에, Starvation(기아 현상)이 야기되는 문제가 있다.</p></div><div class="el-p"><p dir="auto">기아현상이란, 고부하 환경에서 락을 흭득하려는 클라이언트가 많으면, <strong>후순위 요청이</strong> 계속해서 무시될 가능성이 생기긴다.<br>
즉, A투자자가 먼저 투자를 하였음에도 불구하고 그 다음에 실행한 투자자 B,C가 먼저 처리될 수 있다는것이다.</p></div><div class="el-p"><p dir="auto">그리고 실제 운영 환경에서 해당 경우를 심심치 않게 찾아볼 수 있다.</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">최대 30초 이상 대기상태에서 기다린 인원이 있음.<br>
-&gt; 그러나 평균 속도는 대기열에 비해 굉장히 빠르다.(<strong>추가적인 대기열(FIFO 큐)이 없기 때문에 락 획득 속도가 빠름</strong>)</li>
</ul></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="*위에서는 일관성/안정성을 위해 대기열을 포기하고 lock을 사용했다며?*" dir="auto" class="heading" id="*위에서는_일관성/안정성을_위해_대기열을_포기하고_lock을_사용했다며?*"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><em>위에서는 일관성/안정성을 위해 대기열을 포기하고 lock을 사용했다며?</em></h3><div class="heading-children"><div class="el-p"><p dir="auto">해당 질문에 대한 답은,<br>
분산환경에서 고부하 <em>api통신</em>, <em>I/O</em> 작업을 수행하며 적절한 퍼포먼스를 유지하기 위한 타협점 이라고 볼 수 있다.</p></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="해결 방안" dir="auto" class="heading" id="해결_방안"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>해결 방안</h2><div class="heading-children"><div class="el-h4 heading-wrapper"><h4 data-heading="주식 체결과 같이 상품을 미리 열어 주문을 받고, 투자자 별 한도대로 투자를 시행" dir="auto" class="heading" id="주식_체결과_같이_상품을_미리_열어_주문을_받고,_투자자_별_한도대로_투자를_시행"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>주식 체결과 같이 상품을 미리 열어 주문을 받고, 투자자 별 한도대로 투자를 시행</h4><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">상품을 미리 열어, 투자 금액 데이터를 쌓는 원리.</li>
<li data-line="1" dir="auto">해당 방법을 사용하면 데이터 정합성 및 속도를 보장받을 수 있다.</li>
</ul></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="한계" dir="auto" class="heading" id="한계"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>한계</h4><div class="heading-children"><div class="el-ol"><ol>
<li data-line="0" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>투자자 입장에서는 <strong>투자 완료 이후 취소 통보</strong>를 받을 수 있음.
<ul>
<li data-line="1" dir="auto">투자자 개인 한도는 <strong>금융결제위원회</strong>에서 관리하며, 타 업체의 한도와 공유되어 중복투자로인한 취소 가능성</li>
<li data-line="2" dir="auto">상품 투자 한도 초과로 인한 취소가능성<br>
<em>해당 경우에 재 투자를 받아야 할 경우도 생김</em></li>
</ul>
</li>
</ol></div><div class="el-blockquote"><blockquote dir="auto">
<p>사내 정책의 문제 또한 존재하기 때문에, 모든 부분에서 완벽하기란 쉽지 않아 보인다.</p>
</blockquote></div><div class="el-hr"><hr></div></div></div></div></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="이슈" dir="auto" class="heading" id="이슈">이슈</h1><div class="heading-children"><div class="el-h2 heading-wrapper"><h2 data-heading="2.Lock해제와 정합성 이슈" dir="auto" class="heading" id="2.Lock해제와_정합성_이슈"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.Lock해제와 정합성 이슈</h2><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto"><em>lock이 풀리는 이유?</em></li>
</ul></div><div class="el-h3 heading-wrapper"><h3 data-heading="lock으로 묶여있는 한 서비스 로직 내에, 다수의 외부 통신이 포함되어 있음." dir="auto" class="heading" id="lock으로_묶여있는_한_서비스_로직_내에,_다수의_외부_통신이_포함되어_있음."><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>lock으로 묶여있는 한 서비스 로직 내에, 다수의 외부 통신이 포함되어 있음.</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">현재 설정으로, Redisson Lock은 4sec의 TTL을 갖는다.<br>
이때, 외부응답 지연으로 TTL을 초과해 버리게 된다면, lock을 해제함과 동시성이 깨질 수 있는 가능성이 있다.</li>
</ul></div><div class="el-p"><p dir="auto"><strong>어쩨서??</strong></p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">A, B 상품에 대하여, 단일 투자자가 투자를 했을 때<br>
A상품에 대한 투자를 완료처리하여 ( <em>원래였으면 lock처리될</em> )예치금 차감이 되지 않은 상태에서 락이 풀려버린다면?<br>
B상품에 대한 투자도 정상처리가 되어버린다.</li>
</ul></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="해결 방안" dir="auto" class="heading" id="해결_방안"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>해결 방안</h2><div class="heading-children"><div class="el-h4 heading-wrapper"><h4 data-heading="1. 서비스로직 단순화" dir="auto" class="heading" id="1._서비스로직_단순화"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1. 서비스로직 단순화</h4><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">매 투자 건 별로 조회하는 개인별 투자한도를 <em>redis</em>로 관리하여, 투자건별 속도 개선을 목표로함.<br>
<strong>한계</strong> : 투자 건 별 TTL초과 확률을 줄일 수는 있으나, 외부에 의존적인 투자구조 상 100% 해결할 수는 없음</li>
</ul></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2. 먼저 투자를 받은 후, 데이터 순서대로 한도별 투자처리" dir="auto" class="heading" id="2._먼저_투자를_받은_후,_데이터_순서대로_한도별_투자처리"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2. 먼저 투자를 받은 후, 데이터 순서대로 한도별 투자처리</h4><div class="heading-children"><div class="el-p"><p dir="auto">(<u>1번 이슈와 같은 해결 방법</u>)</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">상품을 미리 열어, 투자 금액 데이터를 쌓는 원리.</li>
<li data-line="1" dir="auto">해당 방법을 사용하면 데이터 정합성 및 경합을위한 락 사용 불필요</li>
</ul></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="quote" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-quote"><path d="M16 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z"></path><path d="M5 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z"></path></svg></div><div class="callout-title-inner">결론</div></div><div class="callout-content">
<p dir="auto">현재 <em>신탁 운영</em>으로 인한 한도 데이터를 직접관리하지 못하는 문제와,<br>
보수적인 운영상의 방침으로 큰 구조 개선을 힘들어 보임</p>
<p dir="auto">현재는 리펙토링을 통해 lock에 묶여있는 로직을 단순화 하는것에 만족해야겠음.</p>
</div></div></div><div class="mod-footer mod-ui"></div></div></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="outline-tree tree-container"><div class="tree-item nav-folder mod-root" data-depth="0"><div class="tree-item-self nav-folder-title"><div class="tree-item-inner nav-folder-title-content">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all is-collapsed" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item-children nav-folder-children"><div class="nav-folder-spacer"></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안" data-path="#🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안"><div class="tree-item-inner heading-link" heading-name="🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안">🔐 상품 투자하기 서비스 이슈 및 Lock기법 개선안</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#DB관련_공부_정리_◀" data-path="#DB관련_공부_정리_◀"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="DB관련 공부 정리 ◀">DB관련 공부 정리 ◀</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#[[📔_DataBase]]" data-path="#[[📔_DataBase]]"><div class="tree-item-inner heading-link" heading-name="[[📔 DataBase]]"><span>📔 DataBase</span></div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#투자_서비스에서_어떤_이슈가_있는가?" data-path="#투자_서비스에서_어떤_이슈가_있는가?"><div class="tree-item-inner heading-link" heading-name="투자 서비스에서 어떤 이슈가 있는가?">투자 서비스에서 어떤 이슈가 있는가?</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#상품_투자_서비스_구성" data-path="#상품_투자_서비스_구성"><div class="tree-item-inner heading-link" heading-name="상품 투자 서비스 구성">상품 투자 서비스 구성</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#대기열_대신_Lock기법이_사용된_이유" data-path="#대기열_대신_Lock기법이_사용된_이유"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="대기열 대신 Lock기법이 사용된 이유">대기열 대신 Lock기법이 사용된 이유</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#lock" data-path="#lock"><div class="tree-item-inner heading-link" heading-name="lock">lock</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#ex1)_java_`synchronized`_키워드_사용" data-path="#ex1)_java_`synchronized`_키워드_사용"><div class="tree-item-inner heading-link" heading-name="ex1) java `synchronized` 키워드 사용">ex1) java <code>synchronized</code> 키워드 사용</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#ex2)_Database_Lock" data-path="#ex2)_Database_Lock"><div class="tree-item-inner heading-link" heading-name="ex2) Database Lock">ex2) Database Lock</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#대기열" data-path="#대기열"><div class="tree-item-inner heading-link" heading-name="대기열">대기열</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#결론" data-path="#결론"><div class="tree-item-inner heading-link" heading-name="결론">결론</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#scf의_상품_특성과_이해" data-path="#scf의_상품_특성과_이해"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="scf의 상품 특성과 이해">scf의 상품 특성과 이해</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#락을_잡아놓고(lock안에서의_서비스로직)_api통신을_하는이유?" data-path="#락을_잡아놓고(lock안에서의_서비스로직)_api통신을_하는이유?"><div class="tree-item-inner heading-link" heading-name="락을 잡아놓고(lock안에서의 서비스로직) api통신을 하는이유?">락을 잡아놓고(lock안에서의 서비스로직) api통신을 하는이유?</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#redisson_lock_사용이유" data-path="#redisson_lock_사용이유"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="redisson lock 사용이유">redisson lock 사용이유</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#레디션_락(redisson_lock)이란?" data-path="#레디션_락(redisson_lock)이란?"><div class="tree-item-inner heading-link" heading-name="레디션 락(redisson lock)이란?">레디션 락(redisson lock)이란?</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#결론" data-path="#결론"><div class="tree-item-inner heading-link" heading-name="결론">결론</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#이슈" data-path="#이슈"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="이슈">이슈</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item mod-collapsible is-collapsed" data-depth="2"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#1.투자자_별_투자완료까지의_순서를_보장하지_못한다." data-path="#1.투자자_별_투자완료까지의_순서를_보장하지_못한다."><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.투자자 별 투자완료까지의 순서를 보장하지 못한다.">1.투자자 별 투자완료까지의 순서를 보장하지 못한다.</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#기본_Redisson_Lock의_동작_방식" data-path="#기본_Redisson_Lock의_동작_방식"><div class="tree-item-inner heading-link" heading-name="기본 Redisson Lock의 동작 방식">기본 Redisson Lock의 동작 방식</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#*위에서는_일관성/안정성을_위해_대기열을_포기하고_lock을_사용했다며?*" data-path="#*위에서는_일관성/안정성을_위해_대기열을_포기하고_lock을_사용했다며?*"><div class="tree-item-inner heading-link" heading-name="*위에서는 일관성/안정성을 위해 대기열을 포기하고 lock을 사용했다며?*"><em>위에서는 일관성/안정성을 위해 대기열을 포기하고 lock을 사용했다며?</em></div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="2"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#해결_방안" data-path="#해결_방안"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="해결 방안">해결 방안</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#주식_체결과_같이_상품을_미리_열어_주문을_받고,_투자자_별_한도대로_투자를_시행" data-path="#주식_체결과_같이_상품을_미리_열어_주문을_받고,_투자자_별_한도대로_투자를_시행"><div class="tree-item-inner heading-link" heading-name="주식 체결과 같이 상품을 미리 열어 주문을 받고, 투자자 별 한도대로 투자를 시행">주식 체결과 같이 상품을 미리 열어 주문을 받고, 투자자 별 한도대로 투자를 시행</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#한계" data-path="#한계"><div class="tree-item-inner heading-link" heading-name="한계">한계</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#이슈" data-path="#이슈"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="이슈">이슈</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item mod-collapsible is-collapsed" data-depth="2"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#2.Lock해제와_정합성_이슈" data-path="#2.Lock해제와_정합성_이슈"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="2.Lock해제와 정합성 이슈">2.Lock해제와 정합성 이슈</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="3"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#lock으로_묶여있는_한_서비스_로직_내에,_다수의_외부_통신이_포함되어_있음." data-path="#lock으로_묶여있는_한_서비스_로직_내에,_다수의_외부_통신이_포함되어_있음."><div class="tree-item-inner heading-link" heading-name="lock으로 묶여있는 한 서비스 로직 내에, 다수의 외부 통신이 포함되어 있음.">lock으로 묶여있는 한 서비스 로직 내에, 다수의 외부 통신이 포함되어 있음.</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="2"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#해결_방안" data-path="#해결_방안"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="해결 방안">해결 방안</div></a><div class="tree-item-children" style="display: none;"><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#1._서비스로직_단순화" data-path="#1._서비스로직_단순화"><div class="tree-item-inner heading-link" heading-name="1. 서비스로직 단순화">1. 
서비스로직 단순화
</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="4"><a class="tree-item-self is-clickable" href="issue_troubleshooting/🔐-상품-투자하기-서비스-이슈-및-lock기법-개선안.html#2._먼저_투자를_받은_후,_데이터_순서대로_한도별_투자처리" data-path="#2._먼저_투자를_받은_후,_데이터_순서대로_한도별_투자처리"><div class="tree-item-inner heading-link" heading-name="2. 먼저 투자를 받은 후, 데이터 순서대로 한도별 투자처리">2. 
먼저 투자를 받은 후, 데이터 순서대로 한도별 투자처리
</div></a><div class="tree-item-children"></div></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>